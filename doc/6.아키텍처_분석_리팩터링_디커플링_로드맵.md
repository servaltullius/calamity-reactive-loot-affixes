# 6. 아키텍처 분석 / 리팩터링 / 디커플링 로드맵

## 1) 현재 구조 진단 (2026-02-16)

### 관찰된 결합도 핫스팟
- `EventBridge` 단일 클래스가 너무 많은 역할을 보유
  - 설정 로드/파싱 (`EventBridge.Config.cpp`)
  - 전투 트리거/액션 실행 (`EventBridge.Triggers*.cpp`, `EventBridge.Actions*.cpp`)
  - 런타임 상태/쿨다운/중복가드
  - UI/룬워드/루팅/직렬화
- 파일 크기 기준으로도 집중도가 높음
  - `EventBridge.Config.cpp`: 2k+ lines
  - `EventBridge.Loot.Runeword.cpp`: 1.6k+ lines
  - `EventBridge.Triggers.Events.cpp`: ~800 lines
- 동일 규칙의 중복 구현
  - Player-owned 판정/owner resolve 로직이 `EventBridge`와 `Hooks` 양쪽에 존재

### 리스크
- 규칙이 한쪽만 수정될 때 동작 불일치 가능성 증가
- 회귀 발생 시 원인 추적 범위가 넓어 디버깅 비용 증가
- 신규 기능 추가 시 `EventBridge` 집중도가 더 높아짐

## 2) 이번 착수(1차)에서 적용한 디커플링

### 목표
- 동작 변화 없이 공통 규칙을 한 곳으로 모아 중복 결합 제거

### 변경
- 공용 유틸 추가: `skse/CalamityAffixes/include/CalamityAffixes/PlayerOwnership.h`
  - `IsPlayerOwnedActor(...)`
  - `ResolvePlayerOwnerActor(...)`
- `Hooks.cpp`의 중복 로직 제거 후 공용 유틸 사용
- `EventBridge` 내부 래퍼(`IsPlayerOwned`, `GetPlayerOwner`)도 동일 공용 유틸을 호출하도록 정리
- 전투 관계 컨텍스트 공용화: `skse/CalamityAffixes/include/CalamityAffixes/CombatContext.h`
  - `BuildCombatTriggerContext(...)`
  - `IsHostileEitherDirection(...)`
- non-hostile first-hit 상태 전용 게이트 분리: `skse/CalamityAffixes/include/CalamityAffixes/NonHostileFirstHitGate.h`
  - `EventBridge` 내부 map/TTL/prune 세부구현을 상태 객체로 캡슐화
- per-target ICD 상태 전용 스토어 분리: `skse/CalamityAffixes/include/CalamityAffixes/PerTargetCooldownStore.h`
  - 차단 판정/commit/prune 정책을 `EventBridge`에서 분리

### 기대 효과
- 소유권 판정 규칙 변경 시 수정 지점 단일화
- Hook 경로와 Event 경로 간 판정 일관성 강화
- 전투 판정 정책(소유권/적대관계) 변경 시 호출부 수정 최소화
- first-hit 상태정책 변경 시 EventBridge 비즈니스 코드 영향 축소

## 3) 다음 단계 디커플링 제안 (우선순위)

1. `Combat/Trigger Context` 분리
   - 공격자/소유자/적대관계/first-hit 허용 판정을 별도 컴포넌트화
   - 목표: `Triggers.Events`, `Triggers.HealthDamage`, `Hooks`에서 동일 정책 재사용
2. `Proc Runtime State` 분리
   - 중복가드, per-target ICD, non-hostile first-hit 캐시를 상태 전용 클래스로 이동
   - 목표: 상태 갱신/정리 정책의 테스트 가능성 강화
3. `Action Executor` 분리
   - `Cast/Convert/CoC/Corpse/Trap` 실행기를 타입별 모듈로 분할
   - 목표: 신규 액션 추가 시 영향 반경 축소
4. `Config Loader` 경량화
   - JSON 파싱/검증/런타임 객체 생성 경계를 분리
   - 목표: 설정 변경 회귀 테스트 포인트 명확화

## 4) 설계 원칙 (근거)

- C++ Core Guidelines: 강타입 인터페이스/의존 최소화 지향  
  https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines
- Fowler Refactoring: 동작 보존 하에 작은 단계로 구조 개선  
  https://martinfowler.com/tags/refactoring.html
- Branch by Abstraction: 기능 개발과 구조 분리를 병행하기 위한 점진적 디커플링 전략  
  https://martinfowler.com/bliki/BranchByAbstraction.html
