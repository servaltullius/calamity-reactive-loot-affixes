이 문서는 “어픽스/태그가 수십~수백 개로 늘어날 때 **CK에서 레코드를 일일이 추가/관리**하는 부담”을 줄이기 위해, **B(데이터 주도) 방식**으로 반복 작업을 자동화하는 워크플로우를 정리합니다.

---

## 핵심 아이디어

- 어픽스 = **Keyword(EditorID)** 로 표현 (KID로 분배 가능)
- Keyword/분배 ini는 **JSON 한 파일에서 자동 생성**
- CK는 “퀘스트/에일리어스/스크립트 부착” 같은 **소수의 폼**만 다루고,
  수많은 어픽스 정의/키워드 생성은 자동화로 밀어냅니다.

---

## 현재 지원되는 자동 생성물(v0)

`affixes/affixes.json` → 아래 파일들이 자동 생성됩니다:

- `Data/CalamityAffixes.esp`
  - `CAFF_TAG_DOT` 등 태그 키워드
  - `LoreBox_CAFF_AFFIX_*` 등 어픽스 키워드(이름은 관성으로 유지 중이지만, LoreBox 의존은 없음)
  - MCM Helper용 Quest(`CalamityAffixes_MCM`) + `CalamityAffixes_MCMConfig` 바인딩
  - (선택) `records.magicEffect` / `records.spell` 기반 **MGEF/SPEL 레코드 자동 생성(=CK 0)**
- `Data/CalamityAffixes_KID.ini`
  - (현재) 인스턴스 모드 전용: **어픽스 키워드는 KID로 분배하지 않음**
  - 대신 `keywords.kidRules`(예: DoT 태그 `CAFF_TAG_DOT`)만 출력하여 “태그” 용도로 사용
  - (선택/기본 비활성) DotApply용 DoT 태그: `CAFF_TAG_DOT`을 `*Alch*|H`(알케미 해로운 MGEF)로 태그해 `DotApply` 트리거를 쓸 수 있습니다. 필요하면 `Data/CalamityAffixes_KID.ini`에서 해당 규칙의 chance를 `100`으로 바꾸세요.
  - 주의: `Magic Effect` 태그를 **필터 없이(NONE) 광범위 분배**하면 키워드 기반 디스펠/정화 효과와 상호작용할 수 있어, 생성기는 안전장치로 해당 규칙을 **자동 주석 처리**합니다. 필요 시 `strings/formFilters`를 좁게 설정해 사용하세요.
- `Data/CalamityAffixes_DISTR.ini`
  - NPC/아이템/퍼크/스펠 등 SPID 분배 규칙 (`spidRules` 기반)
- `Data/SKSE/Plugins/CalamityAffixes/affixes.json`
  - 런타임(=SKSE DLL)이 읽는 설정 파일(어픽스 트리거/프로크/ICD/액션)
- `Data/SKSE/Plugins/InventoryInjector/<modKey>.json`
  - (현재) **비어있는 placeholder** I4 설정 파일(`rules: []`)
  - `modKey`가 `CalamityAffixes.esp`라면 파일명은 `CalamityAffixes.json`
  - 주의: InventoryInjector의 `assign.text`는 SkyUI 리스트의 “표시 이름”을 덮어쓰므로, 본 프로젝트에서는 의도적으로 사용하지 않습니다.
  - 본 프로젝트의 기본 UX는 **Prisma UI 오버레이 툴팁 표시** 입니다. (SkyUI/테마 UI와 무관)

---

## 인스턴스 모드(드랍/획득 시점 롤링)

이 프로젝트는 “베이스 아이템에 키워드를 붙이는 KID 분배형”이 아니라,
**아이템 인스턴스(ExtraUniqueID) 단위로 어픽스를 롤링/저장**하는 “loot-time 인스턴스” 방식이 기본입니다.

- 생성기 출력:
  - `Data/CalamityAffixes_KID.ini`는 **어픽스 키워드 분배를 하지 않고**, `keywords.kidRules`만 출력합니다.
    - 대표 예: (선택) DoT 태그 `CAFF_TAG_DOT` (DotApply 트리거용, 기본 비활성)
  - 런타임 동작:
  - SKSE 플러그인이 **플레이어가 아이템을 획득/제작하여 인벤토리에 들어오는 순간** 어픽스를 롤링합니다.
  - 표시(UX):
    - (기본) Prisma UI 오버레이로 `[Affix]` 섹션 표시 (**Prisma UI 필수**)
    - (선택) `loot.renameItem=true`로 아이템 이름에 라벨 부착

`affixes/affixes.json`의 `loot` 섹션 예시:

```json
{
  "loot": {
    "chancePercent": 25.0,
    "renameItem": true,
    "debugLog": false,
    "trapGlobalMaxActive": 64,
    "nameFormat": "{base}[{affix}]"
  }
}
```

## 사용 방법

### 1) 어픽스 추가/수정

- `affixes/affixes.json`에서 `keywords.tags`, `keywords.affixes`, `keywords.kidRules`를 편집합니다.
  - SPID 분배가 필요하면 `keywords.spidRules`도 편집합니다.

### 2) 생성기 실행

```bash
dotnet run --project tools/CalamityAffixes.Generator -- --spec affixes/affixes.json --data Data
```

### 2.5) (권장) 린트/스테일 체크

```bash
python3 tools/lint_affixes.py --spec affixes/affixes.json --generated Data/SKSE/Plugins/CalamityAffixes/affixes.json
```

> 참고: `tools/build_mo2_zip.sh`는 위 린트를 **자동으로 선행 실행**하며, 실패 시 ZIP을 만들지 않습니다.

### 3) MO2 설치용 ZIP 생성(선택)

```bash
tools/build_mo2_zip.sh
```

생성 결과: `dist/CalamityAffixes_MO2_YYYY-MM-DD.zip`

---

## CK 작업은 어디까지 필요한가?

### 반드시 CK가 필요한 영역(선택)

- (선택) Papyrus 기반 매니저(Quest/Alias) 또는 MCM Helper를 **사용하는 경우**
- (선택) 전용 Explosion/Art Object/커스텀 VFX 등 **레코드 생성기가 아직 지원하지 않는 폼**

### “매번 CK로 추가하지 않아도 되는 영역(현재 자동화로 해결)”

- 수많은 Keyword(KYWD) 생성
- KID/SPID ini 작성/갱신(모두 자동 생성)

---

## 운영 팁(중요)

- `Data/CalamityAffixes.esp`는 **자동 생성물**이라 CK로 열어서 수정하지 않는 것을 권장합니다.
- CK에서 작업할 “코어 플러그인”을 별도로 만들고(예: `CalamityAffixes_Core.esp`),
  필요하면 `CalamityAffixes.esp`를 마스터로 로드해서 참조만 하세요.

---

## 런타임 액션(현재 지원)

`affixes.json`의 각 어픽스에 `runtime` 섹션을 넣으면, SKSE 플러그인이 이벤트에서 직접 프로크를 실행합니다.

현재 지원 액션:
- `DebugNotify` : 콘솔 로그 출력(디버그용)
- `CastSpell` : 주문 즉시 발동(대상/자기 자신)
- `SpawnTrap` : 지면 함정 생성(반경/TTL/재무장/글로벌 캡)
- `CastOnCrit` : (플레이어) 치명타/파워어택 적중 시 주문 발동 (글로벌 ICD 0.15s)
- `ConvertDamage` : (플레이어) 무기 물리 피해의 일부를 원소 피해로 전환
- `Archmage` : (플레이어) 주문 적중 시 “최대 매지카 %” 기반 원소 추가 피해 + 추가 비용
- `CorpseExplosion` : (플레이어) 처치 시 시체 폭발(반경/연쇄/레이트리밋 포함)
- `SummonCorpseExplosion` : (플레이어 소유 소환물) 소환물 사망 시 시체 폭발(반경/연쇄/레이트리밋 포함)

`CastSpell` 확장 옵션:
- `evolution` : 프로크마다 XP를 쌓아 단계별 배율을 적용
  - `xpPerProc`(int > 0), `thresholds`(int 배열), `multipliers`(number 배열)
- `modeCycle` : 모드별 주문을 순환
  - `spells`(spellEditorId 문자열 또는 spell 객체 배열), `switchEveryProcs`(int > 0), `labels`(선택)
  - `manualOnly=true` 이면 자동 순환을 끄고 수동 전환만 허용
    - ModEvent `CalamityAffixes_ModeCycle_Next` / `CalamityAffixes_ModeCycle_Prev`로 전환

### Hit 기반 “동적 피해 스케일링” (권장: 후반 대응)

`CastSpell` / `CastOnCrit`는 선택적으로 `magnitudeScaling`을 지원합니다.

- 스케일 소스(`source`):
  - `HitPhysicalDealt` : `HitData.physicalDamage - HitData.resistedPhysicalDamage`
  - `HitTotalDealt` : `HitData.totalDamage - HitData.resistedPhysicalDamage - HitData.resistedTypedDamage`
- 계산식: `scaled = add + mult * sourceValue`
- 옵션:
  - `spellBaseAsMin=true` → 기본 주문/이펙트의 “기본 magnitude”를 최소값으로 사용(초반 성능 유지)
  - `min`/`max` → 추가 clamp (0이면 비활성)
- 주의: `magnitudeScaling`은 `trigger=Hit/IncomingHit`처럼 **HitData가 있는 트리거에서만** 적용됩니다. (Kill/DotApply에서는 무시)

예시(`CastSpell`):

```json
{
  "trigger": "Hit",
  "procChancePercent": 10.0,
  "icdSeconds": 1.25,
  "action": {
    "type": "CastSpell",
    "spellForm": "Skyrim.esm|0001C789",
    "applyTo": "Target",
    "magnitudeScaling": {
      "source": "HitPhysicalDealt",
      "mult": 0.1,
      "add": 0.0,
      "min": 0.0,
      "max": 0.0,
      "spellBaseAsMin": true
    }
  }
}
```

---

## SPID 규칙 작성(옵션)

SPID 문법은 타입별로 포맷이 달라서(Spell/Item/Perk 등) 생성기에서는 **라인을 그대로 출력**하는 방식으로 단순화합니다.

`affixes/affixes.json` 예시:

```json
{
  "keywords": {
    "spidRules": [
      {
        "comment": "예: 모든 NPC에게 Fireball 스펠을 배포(데모)",
        "line": "Spell = Fireball|NONE|NONE|NONE|NONE|NONE|100"
      }
    ]
  }
}
```

- `line`은 SPID의 한 줄을 **그대로** 적습니다. (`Spell = ...`, `Item = ...` 등)

---

## 레코드 자동 생성(Spell + Magic Effect) — CK 0 옵션

아래처럼 `records`를 정의하면, 생성기가 플러그인(`modKey`)에 **Magic Effect(MGEF)** 와 **Spell(SPEL)** 을 같이 생성합니다.

현재 1차 지원 범위(사용자 합의):
- Magic Effect: `ValueModifier`만
- Spell delivery: `Self` / `TargetActor`만

`records.magicEffect` 추가 옵션:
- `recover: true` → Magic Effect의 **Recover** 플래그를 켭니다. (예: `ResistFire`, `DamageResist` 같은 AV 버프/디버프에 필요)

예시:

```json
{
  "records": {
    "magicEffect": {
      "editorId": "CAFF_MGEF_ARC_LIGHTNING",
      "actorValue": "Health",
      "hostile": true
    },
    "spell": {
      "editorId": "CAFF_SPEL_ARC_LIGHTNING",
      "delivery": "TargetActor",
      "effect": {
        "magicEffectEditorId": "CAFF_MGEF_ARC_LIGHTNING",
        "magnitude": 10,
        "duration": 1,
        "area": 0
      }
    }
  }
}
```
